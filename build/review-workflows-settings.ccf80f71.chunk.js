"use strict";(self.webpackChunkserver=self.webpackChunkserver||[]).push([[8155],{97259:(et,N,a)=>{a.r(N),a.d(N,{default:()=>Ke});var t=a(67294),D=a(41054),Z=a(86896),R=a(86706),q=a(88767),v=a(64289),_=a(17034),ee=a(185),te=a(53979),ae=a(29728),oe=a(49066),re=a(77197),ne=a(85018),se=a(45697),g=a.n(se),I=a(1565),k=a(41580),S=a(11047),d=a(53616);function le({status:e,data:o}){return{type:d.QM,payload:{status:e,workflows:o}}}function ie(e){return{type:d.x4,payload:{stageId:e}}}function de(e={}){return{type:d.Ot,payload:e}}function U(e,o){return{type:d.Nj,payload:{stageId:e,...o}}}function ce(e,o){return{type:d.$k,payload:{newIndex:o,oldIndex:e}}}var x=a(75515),ge=a(99782);const P=(0,I.ZP)(ge.Z)`
  > circle {
    fill: ${({theme:e})=>e.colors.neutral150};
  }
  > path {
    fill: ${({theme:e})=>e.colors.neutral600};
  }
`,ue=(0,I.ZP)(k.x)`
  border-radius: 26px;

  svg {
    height: ${({theme:e})=>e.spaces[6]};
    width: ${({theme:e})=>e.spaces[6]};

    > path {
      fill: ${({theme:e})=>e.colors.neutral600};
    }
  }

  &:hover {
    color: ${({theme:e})=>e.colors.primary600} !important;
    ${x.Z} {
      color: ${({theme:e})=>e.colors.primary600} !important;
    }

    ${P} {
      > circle {
        fill: ${({theme:e})=>e.colors.primary600};
      }
      > path {
        fill: ${({theme:e})=>e.colors.neutral100};
      }
    }
  }

  &:active {
    ${x.Z} {
      color: ${({theme:e})=>e.colors.primary600};
    }

    ${P} {
      > circle {
        fill: ${({theme:e})=>e.colors.primary600};
      }
      > path {
        fill: ${({theme:e})=>e.colors.neutral100};
      }
    }
  }
`;function j({children:e,...o}){return t.createElement(ue,{as:"button",background:"neutral0",border:"neutral150",paddingBottom:3,paddingLeft:4,paddingRight:4,paddingTop:3,shadow:"filterShadow",...o},t.createElement(S.k,{gap:2},t.createElement(P,{"aria-hidden":!0}),t.createElement(x.Z,{variant:"pi",fontWeight:"bold",textColor:"neutral500"},e)))}j.propTypes={children:g().node.isRequired};var me=a(63237),fe=a(48734),ve=a(74756),z=a(12028),pe=a(63081),we=a(11276),G=a(74571),Se=a(16364),he=a(54574),ye=a(19270),Ee=a(96404),ke=a(20022),We=a(12814),Ce=a(61080),De=a(13037),Re=a(75194),Ie=a(54878),Me=a(75642),$e=a(47815);const Te=(0,De.s)();function xe(){return t.createElement(k.x,{background:"primary100",borderStyle:"dashed",borderColor:"primary600",borderWidth:"1px",display:"block",hasRadius:!0,padding:6,shadow:"tableShadow"})}function H({id:e,index:o,canDelete:r,canReorder:m,isOpen:i=!1,stagesCount:s}){const n=l=>`${l+1} of ${s}`,u=l=>{y(c({id:"dnd.grab-item",defaultMessage:"{item}, grabbed. Current position in list: {position}. Press up and down arrow to change position, Spacebar to drop, Escape to cancel."},{item:p.value,position:n(l)}))},h=l=>{y(c({id:"dnd.drop-item",defaultMessage:"{item}, dropped. Final position in list: {position}."},{item:p.value,position:n(l)}))},W=()=>{y(c({id:"dnd.cancel-item",defaultMessage:"{item}, dropped. Re-order cancelled."},{item:p.value}))},O=(l,V)=>{y(c({id:"dnd.reorder",defaultMessage:"{item}, moved. New position in list: {position}."},{item:p.value,position:n(l)})),E(ce(V,l))},[b,y]=t.useState(null),{formatMessage:c}=(0,Z.Z)(),{trackUsage:F}=(0,v.rS)(),E=(0,R.I0)(),[$,A]=t.useState(i),[p,B]=(0,D.U$)(`stages.${o}.name`),[f,w]=(0,D.U$)(`stages.${o}.color`),[{handlerId:T,isDragging:C,handleKeyDown:Qe},Xe,Ye,Je,Y]=(0,Me.Y9)(m,{index:o,item:{name:p.value},onGrabItem:u,onDropItem:h,onMoveItem:O,onCancel:W,type:d.uL.STAGE}),qe=(0,$e.FE)(Xe,Ye),J=Te.map(({hex:l,name:V})=>({value:l,label:c({id:"Settings.review-workflows.stage.color.name",defaultMessage:"{name}"},{name:V}),color:l})),_e=J.find(({value:l})=>l===f.value.toUpperCase());return t.useEffect(()=>{Y((0,Ce.rX)(),{captureDraggingState:!1})},[Y,o]),t.createElement(k.x,{ref:qe},b&&t.createElement(me.T,{"aria-live":"assertive"},b),C?t.createElement(xe,null):t.createElement(fe.U,{size:"S",variant:"primary",onToggle:()=>{A(!$),$||F("willEditStage")},expanded:$,shadow:"tableShadow"},t.createElement(ve.B,{title:p.value,togglePosition:"left",action:t.createElement(S.k,null,r&&t.createElement(z.h,{background:"transparent",icon:t.createElement(ke.Z,null),label:c({id:"Settings.review-workflows.stage.delete",defaultMessage:"Delete stage"}),noBorder:!0,onClick:()=>E(ie(e))}),t.createElement(z.h,{background:"transparent",forwardedAs:"div",role:"button",noBorder:!0,tabIndex:0,"data-handler-id":T,ref:Je,label:c({id:"Settings.review-workflows.stage.drag",defaultMessage:"Drag"}),onClick:l=>l.stopPropagation(),onKeyDown:Qe},t.createElement(We.Z,null)))}),t.createElement(pe.v,{padding:6,background:"neutral0",hasRadius:!0},t.createElement(we.r,{gap:4},t.createElement(G.P,{col:6},t.createElement(Se.o,{...p,id:p.name,label:c({id:"Settings.review-workflows.stage.name.label",defaultMessage:"Stage name"}),error:B.error??!1,onChange:l=>{p.onChange(l),E(U(e,{name:l.target.value}))},required:!0})),t.createElement(G.P,{col:6},t.createElement(he.g,{error:w?.error??!1,name:f.name,id:f.name,required:!0},t.createElement(S.k,{direction:"column",gap:1,alignItems:"stretch"},t.createElement(ye.Q,null,c({id:"content-manager.reviewWorkflows.stage.color",defaultMessage:"Color"})),t.createElement(v.JV,{components:{Option:Re.K,SingleValue:Ie.R},error:w?.error,inputId:f.name,name:f.name,options:J,onChange:({value:l})=>{f.onChange({target:{value:l}}),E(U(e,{color:l}))},value:_e??{value:f.value,label:c({id:"Settings.review-workflows.stage.color.name.custom",defaultMessage:"Custom"}),color:f.value}}),t.createElement(Ee.c,null))))))))}H.propTypes=g().shape({id:g().number.isRequired,color:g().string.isRequired,canDelete:g().bool.isRequired,canReorder:g().bool.isRequired,stagesCount:g().number.isRequired}).isRequired;const be=(0,I.ZP)(k.x)`
  position: relative;
`,Ae=(0,I.ZP)(k.x)`
  left: 50%;
  position: absolute;
  top: 0;
  transform: translateX(-50%);
`;function L({stages:e}){const{formatMessage:o}=(0,Z.Z)(),r=(0,R.I0)(),{trackUsage:m}=(0,v.rS)();return t.createElement(S.k,{direction:"column",gap:6,width:"100%"},t.createElement(be,{spacing:4,width:"100%"},t.createElement(Ae,{background:"neutral200",height:"100%",width:2,zIndex:1}),t.createElement(S.k,{direction:"column",alignItems:"stretch",gap:6,zIndex:2,position:"relative",as:"ol"},e.map((i,s)=>{const n=i?.id??i.__temp_key__;return t.createElement(k.x,{key:`stage-${n}`,as:"li"},t.createElement(H,{id:n,index:s,canDelete:e.length>1,isOpen:!i.id,canReorder:e.length>1,stagesCount:e.length}))}))),t.createElement(S.k,{direction:"column",gap:6},t.createElement(j,{type:"button",onClick:()=>{r(de({name:""})),m("willCreateStage")}},o({id:"Settings.review-workflows.stage.add",defaultMessage:"Add new stage"}))))}L.defaultProps={stages:[]},L.propTypes={stages:g().arrayOf(g().shape({id:g().number,__temp_key__:g().number,name:g().string.isRequired}))};var K=a(18172),Ze=a(18446),Pe=a.n(Ze);const Q={status:"loading",serverState:{currentWorkflow:null,workflows:[]},clientState:{currentWorkflow:{data:null,isDirty:!1,hasDeletedServerStages:!1}}};function Le(e=Q,o){return(0,K.Uy)(e,r=>{const{payload:m}=o;switch(o.type){case d.QM:{const{status:i,workflows:s}=m;if(r.status=i,s?.length>0){let n=s[0];n={...n,stages:n.stages.map(u=>({...u,color:u?.color??d.FT}))},r.serverState.workflows=s,r.serverState.currentWorkflow=n,r.clientState.currentWorkflow.data=n,r.clientState.currentWorkflow.hasDeletedServerStages=!1}break}case d.x4:{const{stageId:i}=m,{currentWorkflow:s}=e.clientState;r.clientState.currentWorkflow.data.stages=s.data.stages.filter(n=>(n?.id??n.__temp_key__)!==i),s.hasDeletedServerStages||(r.clientState.currentWorkflow.hasDeletedServerStages=!!e.serverState.currentWorkflow.stages.find(n=>n.id===i));break}case d.Ot:{const{currentWorkflow:i}=e.clientState;i.data||(r.clientState.currentWorkflow.data={stages:[]});const s=Oe(r.clientState.currentWorkflow.data.stages);r.clientState.currentWorkflow.data.stages.push({...m,color:m?.color??d.FT,__temp_key__:s});break}case d.Nj:{const{currentWorkflow:i}=e.clientState,{stageId:s,...n}=m;r.clientState.currentWorkflow.data.stages=i.data.stages.map(u=>(u.id??u.__temp_key__)===s?{...u,...n}:u);break}case d.$k:{const{currentWorkflow:{data:{stages:i}}}=e.clientState,{newIndex:s,oldIndex:n}=m;if(s>=0&&s<i.length){const u=i[n];let h=[...i];h.splice(n,1),h.splice(s,0,u),r.clientState.currentWorkflow.data.stages=h}break}default:break}e.clientState.currentWorkflow.data&&(r.clientState.currentWorkflow.isDirty=!Pe()((0,K.Vk)(r.clientState.currentWorkflow).data,r.serverState.currentWorkflow))})}const Oe=(e=[])=>{const o=e.map(r=>r.id??r.__temp_key__);return Math.max(...o,-1)+1};function Fe(e,o){const r=(0,R.oR)();(0,t.useEffect)(()=>{r.injectReducer(e,o)},[r,e,o])}var Be=a(53752),M=a(87561);function Ve({formatMessage:e}){return M.Ry({stages:M.IX().of(M.Ry().shape({name:M.Z_().required(e({id:"Settings.review-workflows.validation.stage.name",defaultMessage:"Name is required"})).max(255,e({id:"Settings.review-workflows.validation.stage.max-length",defaultMessage:"Name can not be longer than 255 characters"})),color:M.Z_().required(e({id:"Settings.review-workflows.validation.stage.color",defaultMessage:"Color is required"})).matches(/^#(?:[0-9a-fA-F]{3}){1,2}$/i)}))})}var Ne=a(87751),Ue=a(12645);const je=(0,I.ZP)(S.k)`
  svg path {
    fill: ${({theme:e})=>e.colors.neutral600};
  }
`;function X({name:e}){return t.createElement(S.k,{background:"primary100",borderStyle:"dashed",borderColor:"primary600",borderWidth:"1px",gap:3,hasRadius:!0,padding:3,shadow:"tableShadow",width:(0,v.Q1)(300)},t.createElement(je,{alignItems:"center",background:"neutral200",borderRadius:"50%",height:6,justifyContent:"center",width:6},t.createElement(Ue.Z,{width:`${8/16}rem`})),t.createElement(x.Z,{fontWeight:"bold"},e))}X.propTypes={name:g().string.isRequired};var ze=a(27887);function Ge({type:e,item:o}){switch(e){case d.uL.STAGE:return t.createElement(X,{...o});default:return null}}function He(){const{trackUsage:e}=(0,v.rS)(),{formatMessage:o}=(0,Z.Z)(),r=(0,R.I0)(),{put:m}=(0,v.kY)(),{formatAPIError:i}=(0,v.So)(),s=(0,v.lm)(),{workflows:n,refetchWorkflow:u}=(0,Be.n)(),{status:h,clientState:{currentWorkflow:{data:W,isDirty:O,hasDeletedServerStages:b}}}=(0,R.v9)(w=>w?.[d.sN]??Q),[y,c]=(0,t.useState)(!1),{mutateAsync:F,isLoading:E}=(0,q.useMutation)(async({workflowId:w,stages:T})=>{const{data:{data:C}}=await m(`/admin/review-workflows/workflows/${w}/stages`,{data:T});return C},{onSuccess(){s({type:"success",message:{id:"notification.success.saved",defaultMessage:"Saved"}})}}),$=async(w,T)=>{try{return await F({workflowId:w,stages:T})}catch(C){return s({type:"warning",message:i(C)}),null}},A=async()=>{await $(W.id,W.stages),await u(),c(!1)},p=async()=>{await A()},B=()=>{c(w=>!w)},f=(0,D.TA)({enableReinitialize:!0,initialValues:W,async onSubmit(){b?c(!0):A()},validationSchema:Ve({formatMessage:o}),validateOnChange:!1});return Fe(d.sN,Le),(0,t.useEffect)(()=>{r(le({status:n.status,data:n.data}))},[n.status,n.data,r]),(0,t.useEffect)(()=>{e("didViewWorkflow")},[]),t.createElement(v.O4,{permissions:Ne.Z.settings["review-workflows"].main},t.createElement(_.A,null,t.createElement(v.SL,{name:o({id:"Settings.review-workflows.page.title",defaultMessage:"Review Workflows"})}),t.createElement(ee.o,{tabIndex:-1},t.createElement(ze.r,{renderItem:Ge}),t.createElement(D.Hy,{value:f},t.createElement(D.l0,{onSubmit:f.handleSubmit},t.createElement(te.T,{primaryAction:t.createElement(ae.z,{startIcon:t.createElement(ne.Z,null),type:"submit",size:"M",disabled:!O,loading:!y&&E},o({id:"global.save",defaultMessage:"Save"})),title:o({id:"Settings.review-workflows.page.title",defaultMessage:"Review Workflows"}),subtitle:o({id:"Settings.review-workflows.page.subtitle",defaultMessage:"{count, plural, one {# stage} other {# stages}}"},{count:W?.stages?.length??0})}),t.createElement(oe.D,null,h==="loading"&&t.createElement(re.a,null,o({id:"Settings.review-workflows.page.isLoading",defaultMessage:"Workflow is loading"})),t.createElement(L,{stages:f.values?.stages})))),t.createElement(v.QH,{bodyText:{id:"Settings.review-workflows.page.delete.confirm.body",defaultMessage:"All entries assigned to deleted stages will be moved to the previous stage. Are you sure you want to save?"},isConfirmButtonLoading:E,isOpen:y,onToggleDialog:B,onConfirm:p}))))}const Ke=He}}]);
